<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>San Valent√≠n</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a2a; --text:#e8eefc; --muted:#a9b6d3; --accent:#ff4d8d;
      --shadow: 0 16px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}

    /* A prueba de estilos externos */
    [hidden]{ display:none !important; }

    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(255,77,141,.25), transparent 60%),
                  radial-gradient(1000px 600px at 80% 30%, rgba(110,168,255,.18), transparent 55%),
                  var(--bg);
      overflow:hidden;
    }
    .wrap{
      width:min(980px, 92vw);
      display:grid;
      gap:18px;
    }
    header{
      background: rgba(18,26,42,.7);
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px;
      padding:18px 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    h1{margin:0 0 6px; font-size: clamp(18px, 2.4vw, 28px);}
    p{margin:0; color:var(--muted); line-height:1.4}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1.1fr .9fr; align-items:start; }
    }

    .card{
      background: rgba(18,26,42,.7);
      border:1px solid rgba(255,255,255,.08);
      border-radius:24px;
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .puzzleTop{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .btn{
      cursor:pointer;
      border:none;
      padding:10px 14px;
      border-radius:14px;
      background: rgba(255,255,255,.07);
      color:var(--text);
      border:1px solid rgba(255,255,255,.10);
      transition: transform .12s ease, background .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .board{
      width: min(92vw, 520px);
      aspect-ratio: 1 / 1;
      border-radius:18px;
      overflow:hidden;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:6px;
      padding:6px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      margin:0 auto;
      user-select:none;
      touch-action: manipulation;
    }
    .tile{
      border-radius:14px;
      background-size: 300% 300%;
      background-repeat:no-repeat;
      position:relative;
      outline: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
      transition: transform .08s ease, outline-color .12s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .tile:hover{ transform: scale(1.01); outline-color: rgba(255,77,141,.55); }
    .tile.selected{ outline: 2px solid rgba(255,77,141,.95); filter: saturate(1.1); }
    .tile::after{ content:""; }

    .hint{
      font-size:14px;
      color: var(--muted);
      margin-top:10px;
    }

    .ok{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,77,141,.35);
      background: rgba(255,77,141,.10);
      animation: fadeIn .35s ease both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .ok h2{ margin:0 0 6px; font-size:18px;}
    .question{
      font-size:18px;
      margin:0 0 12px;
    }

    .ctaRow{
      position:relative;
      height:90px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      padding:12px;
      touch-action: none;
    }
    .yes{
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(255,140,190,.9));
      border: none;
      color:#0b0f17;
      font-weight:700;
      padding:12px 18px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .12s ease;
    }
    .yes:hover{ transform: translateY(-1px); }
    .no{
      position:absolute;
      left: 62%;
      top: 22px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding:10px 16px;
      border-radius:14px;
      cursor:pointer;
      transition: left .08s linear, top .08s linear;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .final{
      display:none;
      text-align:center;
      padding:16px;
      border-radius:18px;
      background: rgba(110,168,255,.12);
      border:1px solid rgba(110,168,255,.35);
      margin-top:14px;
    }
    .final .big{ font-size:22px; font-weight:800; margin:0 0 6px;}
    .final .small{ color:var(--muted); margin:0;}
    .heart{
      display:inline-block;
      transform-origin:center;
      animation: pop 1.2s ease-in-out infinite;
    }
    @keyframes pop{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.18); }
    }

    canvas{ position:fixed; inset:0; pointer-events:none; }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <div class="wrap">
    <header>
      <h1>Modo San Valent√≠n (edici√≥n inform√°tica)</h1>
      <p>Reconstruye la foto para desbloquear una pregunta importante. Pista: toca dos piezas para intercambiarlas.</p>
    </header>

    <div class="grid">
      <section class="card">
        <div class="puzzleTop">
          <div class="badge">üß© Puzzle 3x3 <span id="moves">¬∑ 0 movimientos</span></div>
          <button class="btn" id="shuffle" type="button">Mezclar</button>
        </div>
        <div class="board" id="board" aria-label="Puzzle"></div>
      </section>

      <aside class="card">
        <div class="badge">‚úÖ Objetivo</div>
        <div class="hint">
          Cuando est√© bien, se desbloquea la pregunta final.<br/>
          Consejo: usa una foto cuadrada para que no recorte raro.
        </div>

        <div class="ok" id="ok" hidden>
          <h2>Acceso concedido</h2>
          <p class="question">¬øQuieres ser mi San Valent√≠n? <span class="heart">‚ù§Ô∏è</span></p>

          <div class="ctaRow" id="ctaRow">
            <button class="yes" id="yes" type="button">S√≠</button>
            <button class="no" id="no" type="button">No</button>
          </div>

          <div class="final" id="final">
            <p class="big">Te quiero much√≠simo ü•∞</p>
            <p class="small">Has desbloqueado el evento: ‚ÄúSan Valent√≠n contigo‚Äù.</p>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const IMG_URL = "assets/photo.jpg";
    const SIZE = 3;
    const TOTAL = SIZE * SIZE;

    const boardEl = document.getElementById("board");
    const movesEl = document.getElementById("moves");
    const okEl = document.getElementById("ok");
    const shuffleBtn = document.getElementById("shuffle");

    let order = [...Array(TOTAL).keys()];
    let selectedPos = null;
    let moves = 0;

    const tiles = [];

    function createTiles(){
      boardEl.innerHTML = "";
      tiles.length = 0;

      for(let pos = 0; pos < TOTAL; pos++){
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.dataset.pos = String(pos);
        tile.addEventListener("click", () => onTileClick(pos));
        tiles.push(tile);
        boardEl.appendChild(tile);
      }
    }

    function applyOrder(){
      for(let pos = 0; pos < TOTAL; pos++){
        const tileIndex = order[pos];
        const tileEl = tiles[pos];

        tileEl.classList.toggle("selected", pos === selectedPos);

        const x = tileIndex % SIZE;
        const y = Math.floor(tileIndex / SIZE);

        tileEl.style.backgroundImage = `url('${IMG_URL}')`;
        tileEl.style.backgroundPosition = `${(x * 100) / (SIZE - 1)}% ${(y * 100) / (SIZE - 1)}%`;
      }

      movesEl.textContent = `¬∑ ${moves} movimientos`;
      checkSolved();
    }

    function swap(a, b){
      const tmp = order[a];
      order[a] = order[b];
      order[b] = tmp;
    }

    function onTileClick(pos){
      if (navigator.vibrate) navigator.vibrate(12);

      if (selectedPos === null){
        selectedPos = pos;
        applyOrder();
        return;
      }

      if (selectedPos === pos){
        selectedPos = null;
        applyOrder();
        return;
      }

      swap(selectedPos, pos);
      selectedPos = null;
      moves++;
      applyOrder();
    }

    function shuffledOrder(){
      const arr = [...Array(TOTAL).keys()];
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      if (arr.every((v, i) => v === i)) return shuffledOrder();
      return arr;
    }

    function checkSolved(){
      const solved = order.every((v, i) => v === i);
      if (solved) unlock();
    }

    function unlock(){
      if (!okEl.hidden) return;
      okEl.hidden = false;
      fireConfetti();
    }

    shuffleBtn.addEventListener("click", () => {
      selectedPos = null;
      order = shuffledOrder();
      moves = 0;

      okEl.hidden = true;
      document.getElementById("final").style.display = "none";

      applyOrder();
    });

    const noBtn = document.getElementById("no");
    const row = document.getElementById("ctaRow");
    const yesBtn = document.getElementById("yes");
    const finalEl = document.getElementById("final");

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    function moveNoButtonAwayFrom(px, py){
      const r = row.getBoundingClientRect();
      const b = noBtn.getBoundingClientRect();

      const padding = 10;
      const maxLeft = r.width - b.width - padding;
      const maxTop  = r.height - b.height - padding;

      const curLeft = parseFloat(noBtn.style.left || "0");
      const curTop  = parseFloat(noBtn.style.top || "0");

      const btnCx = r.left + curLeft + b.width / 2;
      const btnCy = r.top + curTop + b.height / 2;
      const dx = btnCx - px;
      const dy = btnCy - py;

      const push = 80;
      const len = Math.hypot(dx, dy) || 1;

      let newLeft = curLeft + (dx / len) * push + (Math.random() * 30 - 15);
      let newTop  = curTop  + (dy / len) * push + (Math.random() * 30 - 15);

      newLeft = clamp(newLeft, padding, maxLeft);
      newTop  = clamp(newTop, padding, maxTop);

      noBtn.style.left = `${newLeft}px`;
      noBtn.style.top = `${newTop}px`;
    }

    noBtn.style.left = "62%";
    noBtn.style.top = "22px";

    noBtn.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      moveNoButtonAwayFrom(e.clientX, e.clientY);
    });

    row.addEventListener("pointermove", (e) => {
      const b = noBtn.getBoundingClientRect();
      const cx = b.left + b.width / 2;
      const cy = b.top + b.height / 2;
      const dist = Math.hypot(e.clientX - cx, e.clientY - cy);

      if (dist < 90) moveNoButtonAwayFrom(e.clientX, e.clientY);
    });

    yesBtn.addEventListener("click", () => {
      finalEl.style.display = "block";
      fireConfetti();
    });

    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");
    let confetti = [];

    function resize(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    function fireConfetti(){
      const count = 160;
      const cx = canvas.width * 0.5;
      const cy = canvas.height * 0.25;

      for(let i = 0; i < count; i++){
        confetti.push({
          x: cx,
          y: cy,
          vx: (Math.random() * 2 - 1) * (3 + Math.random() * 5),
          vy: (Math.random() * 2 - 1) * (2 + Math.random() * 5) - 6,
          g: 0.18 + Math.random() * 0.12,
          s: 4 + Math.random() * 4,
          r: Math.random() * Math.PI
        });
      }
      if (!animating) animate();
    }

    let animating = false;
    function animate(){
      animating = true;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      confetti = confetti.filter(p => p.y < canvas.height + 40);

      for(const p of confetti){
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.r += 0.12;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.r);
        ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s*0.6);
        ctx.restore();
      }

      if (confetti.length > 0){
        requestAnimationFrame(animate);
      } else {
        animating = false;
      }
    }

    // Init correcto: primero creamos tiles, luego mezclamos, luego pintamos
    okEl.hidden = true;
    createTiles();
    order = shuffledOrder();
    applyOrder();
  </script>
</body>
</html>
