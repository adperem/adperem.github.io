<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>San Valent√≠n</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a2a; --text:#e8eefc; --muted:#a9b6d3; --accent:#ff4d8d;
      --shadow: 0 16px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    [hidden]{ display:none !important; }

    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(255,77,141,.25), transparent 60%),
                  radial-gradient(1000px 600px at 80% 30%, rgba(110,168,255,.18), transparent 55%),
                  var(--bg);
      overflow:hidden;
    }
    canvas#confetti{ position:fixed; inset:0; pointer-events:none; }

    .wrap{ width:min(980px, 92vw); display:grid; gap:18px; }
    header{
      background: rgba(18,26,42,.7);
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px;
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    h1{margin:0 0 6px; font-size: clamp(18px, 2.4vw, 28px);}
    p{margin:0; color:var(--muted); line-height:1.4}

    .grid{ display:grid; grid-template-columns: 1fr; gap:18px; }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1.1fr .9fr; align-items:start; }
    }

    .card{
      background: rgba(18,26,42,.7);
      border:1px solid rgba(255,255,255,.08);
      border-radius:24px;
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .puzzleTop{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .btn{
      cursor:pointer;
      border:none;
      padding:10px 14px;
      border-radius:14px;
      background: rgba(255,255,255,.07);
      color:var(--text);
      border:1px solid rgba(255,255,255,.10);
      transition: transform .12s ease, background .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(255,140,190,.9));
      border:none;
      color:#0b0f17;
      font-weight:800;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .board{
      width: min(92vw, 520px);
      aspect-ratio: 1 / 1;
      border-radius:18px;
      overflow:hidden;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:6px;
      padding:6px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      margin:0 auto;
      user-select:none;
      touch-action: manipulation;
    }
    .tile{
      border-radius:14px;
      background-size: 300% 300%;
      background-repeat:no-repeat;
      outline: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
      transition: transform .08s ease, outline-color .12s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .tile:hover{ transform: scale(1.01); outline-color: rgba(255,77,141,.55); }
    .tile.selected{ outline: 2px solid rgba(255,77,141,.95); filter: saturate(1.1); }

    .hint{ font-size:14px; color: var(--muted); margin-top:10px; }

    .panel{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,77,141,.35);
      background: rgba(255,77,141,.10);
      animation: fadeIn .35s ease both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .panel h2{ margin:0 0 6px; font-size:18px; }
    .panel p{ margin:0 0 10px; }

    .camBox{
      margin-top:10px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .camOverlay{
      position:relative;
    }
    .overlayText{
      position:absolute;
      left:12px;
      right:12px;
      bottom:12px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.88);
      font-size:13px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .previewImg{
      width:100%;
      display:block;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .error{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
      font-size:13px;
    }

    .question{ font-size:18px; margin:0 0 12px; }
    .heart{
      display:inline-block;
      transform-origin:center;
      animation: pop 1.2s ease-in-out infinite;
    }
    @keyframes pop{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.18); }
    }

    .ctaRow{
      position:relative;
      height:90px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      padding:12px;
      touch-action: none;
    }
    .yes{
      background: linear-gradient(135deg, rgba(255,77,141,.95), rgba(255,140,190,.9));
      border:none;
      color:#0b0f17;
      font-weight:800;
      padding:12px 18px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .12s ease;
    }
    .yes:hover{ transform: translateY(-1px); }
    .no{
      position:absolute;
      left: 62%;
      top: 22px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding:10px 16px;
      border-radius:14px;
      cursor:pointer;
      transition: left .08s linear, top .08s linear;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .final{
      display:none;
      text-align:center;
      padding:16px;
      border-radius:18px;
      background: rgba(110,168,255,.12);
      border:1px solid rgba(110,168,255,.35);
      margin-top:14px;
    }
    .final .big{ font-size:22px; font-weight:800; margin:0 0 6px;}
    .final .small{ color:var(--muted); margin:0;}
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <div class="wrap">
    <header>
      <h1>Modo San Valent√≠n (edici√≥n inform√°tica)</h1>
      <p>Primero el puzzle. Luego una prueba con c√°mara. Al final, la pregunta.</p>
    </header>

    <div class="grid">
      <section class="card">
        <div class="puzzleTop">
          <div class="badge">üß© Puzzle 3x3 <span id="moves">¬∑ 0 movimientos</span></div>
          <button class="btn" id="shuffle" type="button">Mezclar</button>
        </div>
        <div class="board" id="board" aria-label="Puzzle"></div>
      </section>

      <aside class="card">
        <div class="badge">‚úÖ Objetivo</div>
        <div class="hint">
          1. Reconstruye la foto.<br/>
          2. Haz una foto con el monito de peluche.<br/>
          3. Se desbloquea la pregunta final.
        </div>

        <div class="panel" id="cameraStep" hidden>
          <h2>Prueba 2: c√°mara</h2>
          <p>Activa la c√°mara y haz una foto sosteniendo el monito de peluche üêí</p>

          <div class="row">
            <button class="btn primary" id="startCam" type="button">Activar c√°mara</button>
            <button class="btn" id="takePhoto" type="button" disabled>Hacer foto</button>
            <button class="btn" id="continueAfterPhoto" type="button" disabled>Continuar</button>
          </div>

          <div class="camBox" id="camBox" hidden>
            <div class="camOverlay">
              <video id="video" autoplay muted playsinline></video>
              <div class="overlayText">
                Mant√©n el monito visible en el encuadre y pulsa ‚ÄúHacer foto‚Äù.
              </div>
            </div>
            <img id="preview" class="previewImg" alt="Foto capturada" hidden />
          </div>

          <div class="error" id="camError" hidden></div>

          <canvas id="snap" hidden></canvas>
        </div>

        <div class="panel" id="finalStep" hidden>
          <h2>Acceso concedido</h2>
          <p class="question">¬øQuieres ser mi San Valent√≠n? <span class="heart">‚ù§Ô∏è</span></p>

          <div class="ctaRow" id="ctaRow">
            <button class="yes" id="yes" type="button">S√≠</button>
            <button class="no" id="no" type="button">No</button>
          </div>

          <div class="final" id="finalMsg">
            <p class="big">Te quiero much√≠simo ü•∞</p>
            <p class="small">Has desbloqueado el evento: ‚ÄúSan Valent√≠n contigo‚Äù.</p>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Foto del puzzle: sanvalentin/assets/photo.jpg
    var IMG_URL = "assets/photo.jpg";

    var SIZE = 3;
    var TOTAL = SIZE * SIZE;

    var boardEl = document.getElementById("board");
    var movesEl = document.getElementById("moves");
    var shuffleBtn = document.getElementById("shuffle");

    var cameraStep = document.getElementById("cameraStep");
    var finalStep = document.getElementById("finalStep");

    var startCamBtn = document.getElementById("startCam");
    var takePhotoBtn = document.getElementById("takePhoto");
    var continueBtn = document.getElementById("continueAfterPhoto");
    var camBox = document.getElementById("camBox");
    var camError = document.getElementById("camError");

    var video = document.getElementById("video");
    var snapCanvas = document.getElementById("snap");
    var previewImg = document.getElementById("preview");

    var yesBtn = document.getElementById("yes");
    var noBtn = document.getElementById("no");
    var row = document.getElementById("ctaRow");
    var finalMsg = document.getElementById("finalMsg");

    var order = [];
    var selectedPos = null;
    var moves = 0;
    var tiles = [];

    var mediaStream = null;
    var photoTaken = false;

    function initOrderSolved(){
      order = [];
      var i = 0;
      while (i < TOTAL){
        order.push(i);
        i++;
      }
    }

    function createTiles(){
      boardEl.innerHTML = "";
      tiles = [];
      var pos = 0;
      while (pos < TOTAL){
        (function(p){
          var tile = document.createElement("div");
          tile.className = "tile";
          tile.dataset.pos = String(p);
          tile.addEventListener("click", function(){ onTileClick(p); });
          tiles.push(tile);
          boardEl.appendChild(tile);
        })(pos);
        pos++;
      }
    }

    function applyOrder(){
      var pos = 0;
      while (pos < TOTAL){
        var tileIndex = order[pos];
        var tileEl = tiles[pos];

        if (pos === selectedPos) tileEl.classList.add("selected");
        else tileEl.classList.remove("selected");

        var x = tileIndex % SIZE;
        var y = Math.floor(tileIndex / SIZE);

        tileEl.style.backgroundImage = "url('" + IMG_URL + "')";
        tileEl.style.backgroundPosition =
          ((x * 100) / (SIZE - 1)) + "% " + ((y * 100) / (SIZE - 1)) + "%";

        pos++;
      }

      movesEl.textContent = "¬∑ " + moves + " movimientos";
      checkSolved();
    }

    function swap(a, b){
      var tmp = order[a];
      order[a] = order[b];
      order[b] = tmp;
    }

    function onTileClick(pos){
      if (navigator.vibrate) navigator.vibrate(12);

      if (selectedPos === null){
        selectedPos = pos;
        applyOrder();
        return;
      }

      if (selectedPos === pos){
        selectedPos = null;
        applyOrder();
        return;
      }

      swap(selectedPos, pos);
      selectedPos = null;
      moves++;
      applyOrder();
    }

    function shuffledOrder(){
      var arr = [];
      var i = 0;
      while (i < TOTAL){
        arr.push(i);
        i++;
      }

      i = arr.length - 1;
      while (i > 0){
        var j = Math.floor(Math.random() * (i + 1));
        var t = arr[i];
        arr[i] = arr[j];
        arr[j] = t;
        i--;
      }

      var solved = true;
      i = 0;
      while (i < arr.length){
        if (arr[i] !== i){ solved = false; break; }
        i++;
      }
      if (solved) return shuffledOrder();
      return arr;
    }

    function checkSolved(){
      var i = 0;
      while (i < TOTAL){
        if (order[i] !== i) return;
        i++;
      }
      unlockPuzzle();
    }

    function unlockPuzzle(){
      if (!cameraStep.hidden) return;
      cameraStep.hidden = false;
      fireConfetti();
    }

    function unlockFinal(){
      if (!finalStep.hidden) return;
      finalStep.hidden = false;
      fireConfetti();
    }

    function resetFlow(){
      stopCamera();
      photoTaken = false;

      cameraStep.hidden = true;
      finalStep.hidden = true;

      camBox.hidden = true;
      camError.hidden = true;
      camError.textContent = "";

      previewImg.hidden = true;
      previewImg.src = "";

      takePhotoBtn.disabled = true;
      continueBtn.disabled = true;
    }

    shuffleBtn.addEventListener("click", function(){
      resetFlow();

      selectedPos = null;
      order = shuffledOrder();
      moves = 0;

      applyOrder();
    });

    // C√°mara
    function showError(msg){
      camError.textContent = msg;
      camError.hidden = false;
    }

    function clearError(){
      camError.textContent = "";
      camError.hidden = true;
    }

    function startCamera(){
      clearError();

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        showError("Este navegador no permite c√°mara. Prueba con Safari o Chrome en el m√≥vil.");
        return;
      }

      navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      }).then(function(stream){
        mediaStream = stream;
        video.srcObject = stream;

        camBox.hidden = false;
        previewImg.hidden = true;

        takePhotoBtn.disabled = false;
        continueBtn.disabled = true;
      }).catch(function(err){
        showError("No se pudo acceder a la c√°mara. Revisa permisos del navegador y vuelve a intentar.");
      });
    }

    function stopCamera(){
      if (!mediaStream) return;
      var tracks = mediaStream.getTracks();
      var i = 0;
      while (i < tracks.length){
        tracks[i].stop();
        i++;
      }
      mediaStream = null;
      video.srcObject = null;
    }

    function takePhoto(){
      if (!mediaStream) return;

      var w = video.videoWidth || 720;
      var h = video.videoHeight || 1280;

      // Mejor aspecto para selfie en vertical
      snapCanvas.width = w;
      snapCanvas.height = h;

      var ctx = snapCanvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      var dataUrl = snapCanvas.toDataURL("image/jpeg", 0.92);
      previewImg.src = dataUrl;
      previewImg.hidden = false;

      photoTaken = true;
      continueBtn.disabled = false;

      // Si quieres, puedes parar c√°mara al hacer la foto:
      // stopCamera();
    }

    startCamBtn.addEventListener("click", function(){
      startCamera();
    });

    takePhotoBtn.addEventListener("click", function(){
      takePhoto();
    });

    continueBtn.addEventListener("click", function(){
      if (!photoTaken){
        showError("Primero haz la foto con el monito.");
        return;
      }
      stopCamera();
      unlockFinal();
    });

    window.addEventListener("pagehide", function(){
      stopCamera();
    });

    // Bot√≥n No que huye
    function clamp(v, min, max){
      return Math.max(min, Math.min(max, v));
    }

    function moveNoButtonAwayFrom(px, py){
      var r = row.getBoundingClientRect();
      var b = noBtn.getBoundingClientRect();

      var padding = 10;
      var maxLeft = r.width - b.width - padding;
      var maxTop = r.height - b.height - padding;

      var curLeft = parseFloat(noBtn.style.left || "0");
      var curTop = parseFloat(noBtn.style.top || "0");

      var btnCx = r.left + curLeft + b.width / 2;
      var btnCy = r.top + curTop + b.height / 2;

      var dx = btnCx - px;
      var dy = btnCy - py;

      var push = 80;
      var len = Math.hypot(dx, dy) || 1;

      var newLeft = curLeft + (dx / len) * push + (Math.random() * 30 - 15);
      var newTop = curTop + (dy / len) * push + (Math.random() * 30 - 15);

      newLeft = clamp(newLeft, padding, maxLeft);
      newTop = clamp(newTop, padding, maxTop);

      noBtn.style.left = newLeft + "px";
      noBtn.style.top = newTop + "px";
    }

    noBtn.style.left = "62%";
    noBtn.style.top = "22px";

    noBtn.addEventListener("pointerdown", function(e){
      e.preventDefault();
      moveNoButtonAwayFrom(e.clientX, e.clientY);
    });

    row.addEventListener("pointermove", function(e){
      if (finalStep.hidden) return;

      var b = noBtn.getBoundingClientRect();
      var cx = b.left + b.width / 2;
      var cy = b.top + b.height / 2;
      var dist = Math.hypot(e.clientX - cx, e.clientY - cy);

      if (dist < 90) moveNoButtonAwayFrom(e.clientX, e.clientY);
    });

    yesBtn.addEventListener("click", function(){
      finalMsg.style.display = "block";
      fireConfetti();
    });

    // Confetti simple
    var confettiCanvas = document.getElementById("confetti");
    var confettiCtx = confettiCanvas.getContext("2d");
    var confetti = [];
    var animating = false;

    function resize(){
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    function fireConfetti(){
      var count = 160;
      var cx = confettiCanvas.width * 0.5;
      var cy = confettiCanvas.height * 0.25;

      var i = 0;
      while (i < count){
        confetti.push({
          x: cx,
          y: cy,
          vx: (Math.random() * 2 - 1) * (3 + Math.random() * 5),
          vy: (Math.random() * 2 - 1) * (2 + Math.random() * 5) - 6,
          g: 0.18 + Math.random() * 0.12,
          s: 4 + Math.random() * 4,
          r: Math.random() * Math.PI
        });
        i++;
      }

      if (!animating) animate();
    }

    function animate(){
      animating = true;
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

      confetti = confetti.filter(function(p){
        return p.y < confettiCanvas.height + 40;
      });

      var i = 0;
      while (i < confetti.length){
        var p = confetti[i];
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.r += 0.12;

        confettiCtx.save();
        confettiCtx.translate(p.x, p.y);
        confettiCtx.rotate(p.r);
        confettiCtx.fillRect(-p.s/2, -p.s/2, p.s, p.s*0.6);
        confettiCtx.restore();

        i++;
      }

      if (confetti.length > 0){
        requestAnimationFrame(animate);
      } else {
        animating = false;
      }
    }

    // Init
    resetFlow();
    initOrderSolved();
    createTiles();
    order = shuffledOrder();
    applyOrder();
  </script>
</body>
</html>
